#!/usr/bin/env bash
# ~/.config/niri/scripts/generate_workspace_config.sh

CONFIG_FILE="$HOME/.config/niri/workspaces.conf"
LOG_FILE="$HOME/.config/niri/workspace-gen.log"
LAPTOP_MONITOR="eDP-1" # Change to your laptop monitor

# Logging function
log_msg() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Wait for Hyprland socket to be available
wait_for_hyprland() {
  local max_attempts=20
  local attempt=0
  local socket_path="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket.sock"

  log_msg "Waiting for Hyprland socket (HYPRLAND_INSTANCE_SIGNATURE=$HYPRLAND_INSTANCE_SIGNATURE)"

  while [ $attempt -lt $max_attempts ]; do
    if [ -S "$socket_path" ]; then
      # Socket exists, now check if hyprctl responds with valid monitor data
      if hyprctl monitors -j 2>/dev/null | jq -e '.[0].name' &>/dev/null; then
        log_msg "Hyprland socket ready after $attempt attempts"
        return 0
      fi
    fi
    attempt=$((attempt + 1))
    sleep 0.5
  done

  log_msg "ERROR: Hyprland socket not ready after $max_attempts attempts (10s timeout)"
  return 1
}

# Validate monitor data
get_monitors() {
  local monitors
  monitors=$(hyprctl monitors -j 2>/dev/null | jq -r '.[].name' 2>/dev/null)

  if [ -z "$monitors" ]; then
    # Fallback to text parsing
    monitors=$(hyprctl monitors 2>/dev/null | grep -oP 'Monitor \K\S+')
  fi

  echo "$monitors"
}

# Wait for Hyprland to be ready
if ! wait_for_hyprland; then
  log_msg "WARNING: Proceeding without confirmed socket - may fail"
  # If existing config exists, keep it and exit
  if [ -f "$CONFIG_FILE" ]; then
    log_msg "Using existing workspaces.conf as fallback"
    exit 0
  fi
fi

# Get connected monitors
MONITORS=$(get_monitors)
if [ -z "$MONITORS" ]; then
  log_msg "ERROR: No monitors detected, using fallback single-monitor config"
  MONITORS="$LAPTOP_MONITOR"
fi

log_msg "Detected monitors: $(echo $MONITORS | tr '\n' ' ')"
EXTERNAL_MONITOR=$(echo "$MONITORS" | grep -v "$LAPTOP_MONITOR" | head -1)

# Generate workspace configuration
cat >"$CONFIG_FILE" <<EOF
# Auto-generated workspace configuration
# Generated on: $(date)

# Monitor setup
monitor = $LAPTOP_MONITOR,preferred,0x0,1
EOF

if [ "$EXTERNAL_MONITOR" != "" ]; then
  cat >>"$CONFIG_FILE" <<EOF
# monitor = $EXTERNAL_MONITOR,preferred,auto,1,
monitor = $EXTERNAL_MONITOR,highrr,auto,1,

# Dual monitor workspace assignment
workspace = 1, monitor:$LAPTOP_MONITOR, persistent:true, default:true
workspace = 2, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 3, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 4, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 5, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 11, monitor:$LAPTOP_MONITOR, persistent:true, default:true
workspace = 12, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 13, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 14, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 15, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 6, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 7, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 8, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 9, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 10, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 16, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 17, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 18, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 19, monitor:$EXTERNAL_MONITOR, persistent:true
workspace = 20, monitor:$EXTERNAL_MONITOR, persistent:true

# Additional keybindings for external monitor workspaces
bind = SUPER, F1, workspace, 11
bind = SUPER, F2, workspace, 12
bind = SUPER, F3, workspace, 13
bind = SUPER, F4, workspace, 14
bind = SUPER, F5, workspace, 15
bind = SUPER, F6, workspace, 16
bind = SUPER, F7, workspace, 17
bind = SUPER, F8, workspace, 18
bind = SUPER, F9, workspace, 19
bind = SUPER, F10, workspace, 20

bind = SUPER_SHIFT, F1, movetoworkspace, 11
bind = SUPER_SHIFT, F2, movetoworkspace, 12
bind = SUPER_SHIFT, F3, movetoworkspace, 13
bind = SUPER_SHIFT, F4, movetoworkspace, 14
bind = SUPER_SHIFT, F5, movetoworkspace, 15
bind = SUPER_SHIFT, F6, movetoworkspace, 16
bind = SUPER_SHIFT, F7, movetoworkspace, 17
bind = SUPER_SHIFT, F8, movetoworkspace, 18
bind = SUPER_SHIFT, F9, movetoworkspace, 19
bind = SUPER_SHIFT, F10, movetoworkspace, 20
EOF
else
  cat >>"$CONFIG_FILE" <<EOF

# Single monitor workspace assignment
workspace = 1, monitor:$LAPTOP_MONITOR, persistent:true, default:true
workspace = 2, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 3, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 4, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 5, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 6, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 7, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 8, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 9, monitor:$LAPTOP_MONITOR, persistent:true
workspace = 10, monitor:$LAPTOP_MONITOR, persistent:true

EOF
fi

log_msg "Workspace configuration generated: $CONFIG_FILE (external=$EXTERNAL_MONITOR)"
echo "Workspace configuration generated: $CONFIG_FILE"

# Reload Hyprland config if running
if pgrep -x "Hyprland" >/dev/null; then
  hyprctl reload
  log_msg "Hyprland config reloaded"
fi
