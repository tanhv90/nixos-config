#!/usr/bin/env bash
# Helper script to generate ~/.config/niri/monitor-vars.conf
# Run this to configure your monitor settings

VARS_FILE="$HOME/.config/niri/monitor-vars.conf"

echo "=== Hyprland Monitor Setup ==="
echo ""

# Check if hyprctl is available
if ! command -v hyprctl &>/dev/null; then
  echo "ERROR: hyprctl not found. Are you running Hyprland?"
  exit 1
fi

# Get current monitors
MONITOR_JSON=$(hyprctl monitors -j 2>/dev/null)
if [ -z "$MONITOR_JSON" ]; then
  echo "ERROR: No monitors detected"
  exit 1
fi

echo "Detected monitors:"
echo ""

# List monitors with details
MONITOR_COUNT=$(echo "$MONITOR_JSON" | jq length)
for i in $(seq 0 $((MONITOR_COUNT - 1))); do
  NAME=$(echo "$MONITOR_JSON" | jq -r ".[$i].name")
  WIDTH=$(echo "$MONITOR_JSON" | jq -r ".[$i].width")
  HEIGHT=$(echo "$MONITOR_JSON" | jq -r ".[$i].height")
  REFRESH=$(echo "$MONITOR_JSON" | jq -r ".[$i].refreshRate")
  echo "  [$((i + 1))] $NAME - ${WIDTH}x${HEIGHT} @ ${REFRESH}Hz"
done
echo ""

# Select primary monitor
MONITORS=$(echo "$MONITOR_JSON" | jq -r '.[].name')
MONITOR_ARRAY=($MONITORS)

if [ "$MONITOR_COUNT" -eq 1 ]; then
  PRIMARY_MONITOR="${MONITOR_ARRAY[0]}"
  echo "Only one monitor detected, using $PRIMARY_MONITOR as primary."
else
  read -p "Select primary monitor number [1-$MONITOR_COUNT]: " PRIMARY_NUM
  if [ -z "$PRIMARY_NUM" ] || [ "$PRIMARY_NUM" -lt 1 ] || [ "$PRIMARY_NUM" -gt "$MONITOR_COUNT" ]; then
    echo "Invalid selection, using first monitor."
    PRIMARY_NUM=1
  fi
  PRIMARY_MONITOR="${MONITOR_ARRAY[$((PRIMARY_NUM - 1))]}"
fi

# Get primary resolution
PRIMARY_WIDTH=$(echo "$MONITOR_JSON" | jq -r ".[] | select(.name == \"$PRIMARY_MONITOR\") | .width")
PRIMARY_HEIGHT=$(echo "$MONITOR_JSON" | jq -r ".[] | select(.name == \"$PRIMARY_MONITOR\") | .height")
PRIMARY_RESOLUTION="${PRIMARY_WIDTH}x${PRIMARY_HEIGHT}"

echo ""
echo "Primary monitor: $PRIMARY_MONITOR ($PRIMARY_RESOLUTION)"

# Get external resolution if multiple monitors
EXTERNAL_RESOLUTION=""
if [ "$MONITOR_COUNT" -gt 1 ]; then
  EXTERNAL_MONITOR=$(echo "$MONITORS" | grep -v "$PRIMARY_MONITOR" | head -1)
  EXTERNAL_WIDTH=$(echo "$MONITOR_JSON" | jq -r ".[] | select(.name == \"$EXTERNAL_MONITOR\") | .width")
  EXTERNAL_HEIGHT=$(echo "$MONITOR_JSON" | jq -r ".[] | select(.name == \"$EXTERNAL_MONITOR\") | .height")
  EXTERNAL_RESOLUTION="${EXTERNAL_WIDTH}x${EXTERNAL_HEIGHT}"
  echo "External monitor: $EXTERNAL_MONITOR ($EXTERNAL_RESOLUTION)"
fi

echo ""

# Confirm before writing
read -p "Save this configuration to $VARS_FILE? [Y/n]: " CONFIRM
if [ "${CONFIRM,,}" = "n" ]; then
  echo "Aborted."
  exit 0
fi

# Write config file
cat > "$VARS_FILE" << EOF
# Hyprland monitor configuration
# Generated by setup-monitors on $(date)
# Priority: This file > Nix config > auto-detect
#
# Available variables:
#   VAR_PRIMARY_MONITOR    - Primary monitor name (e.g., eDP-1)
#   VAR_PRIMARY_RESOLUTION - Primary resolution (e.g., 3840x2400)
#   VAR_EXTERNAL_RESOLUTION - External monitor resolution
#   VAR_EXTERNAL_POSITION  - Position: left, right, above, below (default: right)
#   VAR_REFRESH_RATE       - Refresh rate: preferred, highrr, highres (default: preferred)
#   VAR_DISTRIBUTION       - Workspace distribution: split, primary-all (default: split)
#   VAR_GENERATE_FKEYS     - Generate F1-F10 bindings: true, false (default: true)

VAR_PRIMARY_MONITOR="$PRIMARY_MONITOR"
VAR_PRIMARY_RESOLUTION="$PRIMARY_RESOLUTION"
EOF

if [ -n "$EXTERNAL_RESOLUTION" ]; then
  echo "VAR_EXTERNAL_RESOLUTION=\"$EXTERNAL_RESOLUTION\"" >> "$VARS_FILE"
fi

cat >> "$VARS_FILE" << EOF

# Uncomment and modify as needed:
# VAR_EXTERNAL_POSITION="right"
# VAR_REFRESH_RATE="preferred"
# VAR_DISTRIBUTION="split"
# VAR_GENERATE_FKEYS="true"
EOF

echo ""
echo "Configuration saved to $VARS_FILE"
echo ""
echo "To apply changes, run:"
echo "  ~/.config/niri/scripts/generate_workspace_config"
echo ""
echo "Or restart Hyprland."
