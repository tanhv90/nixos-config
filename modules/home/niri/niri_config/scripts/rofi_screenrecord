#!/usr/bin/env bash

## Screen recording menu for Niri using wf-recorder

# Import Current Theme
DIR="$HOME/.config/niri"
RASI="$DIR/rofi/screenrecord.rasi"
PIDFILE="/tmp/screenrecord.pid"

# Check if recording is in progress
is_recording() {
    [[ -f "$PIDFILE" ]] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null
}

# Theme Elements
if is_recording; then
    prompt='Recording'
    mesg="Recording in progress - Select to stop"
else
    prompt='Record'
    mesg="Directory :: $HOME/Videos/Recordings"
fi

# Options
layout=$(cat "$RASI" | grep 'USE_ICON' | cut -d'=' -f2)
if [[ "$layout" == 'NO' ]]; then
    if is_recording; then
        option_1="󰓛 Stop Recording"
    else
        option_1="󰍹 Record Screen"
        option_2="󰩭 Record Area"
        option_3="󰍹󰍬 Screen + Audio"
        option_4="󰩭󰍬 Area + Audio"
        option_5="󰓛 Stop Recording"
    fi
else
    if is_recording; then
        option_1="󰓛"
    else
        option_1="󰍹"
        option_2="󰩭"
        option_3="󰍬"
        option_4="󰕧"
        option_5="󰓛"
    fi
fi

# Rofi CMD
rofi_cmd() {
    rofi -dmenu \
        -p "$prompt" \
        -mesg "$mesg" \
        -markup-rows \
        -theme "$RASI"
}

# Pass variables to rofi dmenu
run_rofi() {
    if is_recording; then
        echo -e "$option_1" | rofi_cmd
    else
        echo -e "$option_1\n$option_2\n$option_3\n$option_4\n$option_5" | rofi_cmd
    fi
}

# Execute Command
run_cmd() {
    case "$1" in
        --opt1)
            if is_recording; then
                ~/.config/niri/scripts/screenrecord --stop
            else
                ~/.config/niri/scripts/screenrecord --screen
            fi
            ;;
        --opt2)
            ~/.config/niri/scripts/screenrecord --area
            ;;
        --opt3)
            ~/.config/niri/scripts/screenrecord --screen-audio
            ;;
        --opt4)
            ~/.config/niri/scripts/screenrecord --area-audio
            ;;
        --opt5)
            ~/.config/niri/scripts/screenrecord --stop
            ;;
    esac
}

# Actions
chosen="$(run_rofi)"

# Exit if no selection (ESC pressed)
[[ -z "$chosen" ]] && exit 0

case ${chosen} in
    "$option_1") run_cmd --opt1 ;;
    "$option_2") run_cmd --opt2 ;;
    "$option_3") run_cmd --opt3 ;;
    "$option_4") run_cmd --opt4 ;;
    "$option_5") run_cmd --opt5 ;;
esac
